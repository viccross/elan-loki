server:
  disable: false
  http_listen_port: 0
  grpc_listen_port: 0
  log_level: error
positions:
  filename: /opt/mqtt_promtail/positions.yaml
clients:
  - url: http://127.0.0.1:3100/loki/api/v1/push
scrape_configs:
  - job_name: mqtt_logger
    pipeline_stages:
      - json:
          expressions:
            mqtt_tst: tst
            mqtt_topic: topic
            mqtt_payload: payload
      - regex:
          expression: '(?P<mqtt_node>[^\/]+)/(?P<zvm_sys>[^\/]+)/(?P<zvm_type>[^\/]+)/(?P<cat>[^\/]+)/(?P<f1>[^\/]*)(/(?P<f2>[^\/]*))?$'
          source: mqtt_topic
      - labels:
          mqtt_topic: null
          mqtt_node: null
          zvm_sys: null
          zvm_type: null
      - timestamp:
          source: mqtt_tst
          format: '2006-01-02T15:04:05.000000-0700'
      - match:
          selector: '{mqtt_node="zvm"}'
          stages:
          - match:
              selector: '{zvm_type="msg"}'
              stages:
              - labels:
                  zvm_user: f1
              - output:
                  source: mqtt_payload
          - match:
              selector: '{zvm_type="vmevent"}'
              stages:
              - labels:
                  vmev_class: cat
                  vmev_type: f1
              - match:
                  selector: '{vmev_class="0"}'
                  stages:
                  - labels:
                      zvm_user: f2
                  - output:
                      source: mqtt_payload
              - match:
                  selector: '{vmev_class="1"}'
                  stages:
                  - labels:
                      zvm_user: f2
                  - output:
                      source: mqtt_payload
              - match:
                  selector: '{vmev_class="2"}'
                  stages:
                  - output:
                      source: mqtt_payload
              - match:
                  selector: '{vmev_class="3"}'
                  stages:
                  - output:
                      source: mqtt_payload
              - match:
                  selector: '{vmev_class="4"}'
                  stages:
                  - output:
                      source: mqtt_payload
    static_configs:
      - targets:
          - localhost
        labels:
          job: mqtt_logger
          host_hostname: localhost
